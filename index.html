<!DOCTYPE html>
<html lang="en" id="html-root" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SharePlate Pro v2 - Live Sync</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        kurdish: ['Noto Naskh Arabic', 'serif']
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-glow': 'pulseGlow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    },
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc' }
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  ‚úÖ KEYS REVERTED TO PREVIOUS VERSION ‚úÖ
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCXe9sQiA-Z5qQNYHFS1eGDkT366VlHfDI", // Reverted to lowercase 'f'
            authDomain: "shareplate-6b668.firebaseapp.com",
            projectId: "shareplate-6b668",
            storageBucket: "shareplate-6b668.firebasestorage.app",
            messagingSenderId: "468190117194",
            appId: "1:468190117194:web:9f463d37b7f9aaa27715b3",
            measurementId: "G-S13DB80B1V"
        };
        // ==========================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for access
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shareplate-global-v2';
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.signOut = signOut;
        window.appId = appId;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.arrayUnion = arrayUnion;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        window.isConfigured = true;

        // Force Login Helper
        window.forceLogin = async () => {
            window.showToast("Connecting...", "normal");
            try {
                await signInAnonymously(auth);
                window.showToast("Connected Successfully!", "success");
            } catch (error) {
                console.error("Auth failed", error);
                let errorMsg = `Error: ${error.code}`;
                
                if (error.code === 'auth/api-key-not-valid') {
                    errorMsg = "INVALID API KEY! Check config.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = "Network Error: Check WiFi/Data";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMsg = "Enable Anonymous Auth in Console";
                }
                
                window.showToast(errorMsg, "error");
            }
        };

        // Auth Logic
        onAuthStateChanged(auth, (user) => {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status-text');
            
            if (user) {
                window.currentUser = user;
                if(window.startRealtimeListeners) window.startRealtimeListeners();
                
                if(indicator) { indicator.classList.remove('bg-red-500'); indicator.classList.add('bg-emerald-500', 'animate-pulse'); }
                if(statusText) statusText.innerText = "Online";
                if(window.render) window.render(); 
                
                if(document.getElementById('setup-screen')) window.showToast("Connected Successfully!");
            } else {
                window.currentUser = null;
                if(indicator) { indicator.classList.add('bg-red-500'); indicator.classList.remove('bg-emerald-500', 'animate-pulse'); }
                if(statusText) statusText.innerText = "Offline";
                
                window.forceLogin();
            }
        });
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .glass-dark { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        body { background-color: #f8fafc; overflow: hidden; margin: 0; padding: 0; }
        html.dark body { background-color: #0f172a; }
        .font-kurdish { font-family: 'Noto Naskh Arabic', serif; }
        .page-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .qr-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        /* Map specific styles */
        #map-container { height: 100%; width: 100%; border-radius: 0; z-index: 0; }
        .leaflet-bottom.leaflet-right { display: none; } /* Hide attribution for cleaner mobile UI */
    </style>
</head>
<body class="flex justify-center items-center min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-500 selection:bg-violet-500 selection:text-white sm:p-4 p-0">

    <!-- Device Frame -->
    <div id="app-frame" class="w-full sm:max-w-md h-[100dvh] sm:h-[850px] bg-slate-50 dark:bg-slate-900 rounded-none sm:rounded-[40px] shadow-2xl overflow-hidden relative flex flex-col sm:border-[10px] border-slate-900 ring-4 ring-slate-900/50 transition-colors duration-300">
        
        <!-- Status Bar -->
        <div class="h-12 w-full absolute top-0 z-40 flex items-center justify-between px-6 text-xs font-bold text-slate-800 dark:text-white pointer-events-none">
            <span id="clock">9:41</span>
            <div class="flex gap-2 items-center">
                <div class="flex items-center gap-1 bg-black/10 dark:bg-white/10 px-2 py-0.5 rounded-full backdrop-blur-sm pointer-events-auto cursor-pointer" onclick="window.forceLogin()">
                    <div id="connection-indicator" class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-500"></div>
                    <span id="connection-status-text" class="text-[9px] font-bold opacity-80 uppercase">Offline</span>
                </div>
                <div class="flex gap-1.5 ml-1">
                    <div class="w-4 h-4 rounded-full bg-slate-900 dark:bg-white flex items-center justify-center"><i data-lucide="wifi" class="w-3 h-3 text-white dark:text-slate-900"></i></div>
                    <div class="w-4 h-4 rounded-full bg-slate-900 dark:bg-white flex items-center justify-center"><i data-lucide="battery" class="w-3 h-3 text-white dark:text-slate-900"></i></div>
                </div>
            </div>
        </div>

        <!-- Dynamic Background Blobs -->
        <div class="absolute inset-0 z-0 opacity-30 pointer-events-none overflow-hidden">
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-violet-400 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-float dark:bg-violet-900"></div>
            <div class="absolute top-[20%] right-[-10%] w-72 h-72 bg-emerald-400 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-float dark:bg-emerald-900" style="animation-delay: 2s"></div>
            <div class="absolute bottom-[-10%] left-[20%] w-80 h-80 bg-pink-400 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-float dark:bg-pink-900" style="animation-delay: 4s"></div>
        </div>

        <!-- Notifications -->
        <div id="toast-container" class="absolute top-14 left-0 right-0 z-[60] flex flex-col items-center gap-2 pointer-events-none px-4 transition-all"></div>

        <!-- Main Scrollable Area -->
        <div id="main-content" class="flex-1 overflow-y-auto scrollbar-hide relative z-10 pt-12 pb-24 page-transition">
            <div class="h-full flex items-center justify-center">
                <div class="animate-pulse flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-violet-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-400 font-bold text-sm">Syncing Database...</p>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div id="nav-bar" class="hidden absolute bottom-0 left-0 right-0 glass dark:glass-dark border-t border-slate-200/50 dark:border-slate-700/50 px-6 py-2 flex justify-between items-end z-50 pb-6 rounded-b-[32px] sm:rounded-b-[28px]">
            <button onclick="setView('browse')" class="nav-btn w-12 h-12 flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-violet-600 transition-colors" id="nav-browse">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold">Home</span>
            </button>
            <button onclick="setView('map')" class="nav-btn w-12 h-12 flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-violet-600 transition-colors" id="nav-map">
                <i data-lucide="map" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold">Map</span>
            </button>
            <div class="relative -top-6">
                <button onclick="setView('donate')" class="bg-gradient-to-tr from-violet-600 to-indigo-600 text-white w-16 h-16 rounded-full shadow-lg shadow-violet-500/40 hover:scale-110 active:scale-95 transition-all flex items-center justify-center border-[6px] border-slate-50 dark:border-slate-900 group">
                    <i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition-transform"></i>
                </button>
            </div>
            <button onclick="setView('activity')" class="nav-btn w-12 h-12 flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-violet-600 transition-colors relative" id="nav-activity">
                <i data-lucide="layout-list" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold">Activity</span>
            </button>
            <button onclick="setView('profile')" class="nav-btn w-12 h-12 flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-violet-600 transition-colors" id="nav-profile">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold">Profile</span>
            </button>
        </div>

        <!-- Full Screen Modals - Increased Z-Index to cover Nav Bar -->
        <div id="modal-layer" class="absolute inset-0 z-[70] pointer-events-none flex items-end justify-center">
            <div id="modal-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-none" onclick="closeModal()"></div>
            <div id="modal-sheet" class="bg-white dark:bg-slate-800 w-full h-[90%] rounded-t-[32px] shadow-[0_-10px_40px_rgba(0,0,0,0.3)] transform translate-y-full transition-transform duration-300 flex flex-col overflow-hidden pointer-events-auto">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mt-4 mb-2 shrink-0"></div>
                <!-- INCREASED PADDING HERE (pb-44) TO SHOW DELETE BUTTON -->
                <div id="modal-content" class="flex-1 overflow-y-auto scrollbar-hide p-6 pb-44 overscroll-contain"></div>
            </div>
        </div>

    </div>

    <script>
        const I18N = { 
            en: { welcome: "Good Morning", subtitle: "Live Sync Active ‚Ä¢ PC ‚áÑ Mobile", donateTitle: "Share Food", itemName: "Item Title", post: "Publish Donation", activity: "My Activity", chat: "Discussion", darkmode: "Dark Mode" }, 
            ku: { welcome: "Beyani Bash", subtitle: "Ba xwardn rizgarkain!", donateTitle: "Bexshini Xwardn", itemName: "Nawi Babat", post: "Bilawkrdnawa", activity: "Chalaki", chat: "Chati Gisti", darkmode: "Tariki" } 
        };
        let state = { 
            view: 'login', 
            user: null, 
            lang: 'en', 
            darkMode: false, 
            activeCategory: 'All', 
            selectedMapItemId: null, 
            donationLocation: null, 
            donationCoords: null, // Store actual GPS coords
            items: [], 
            chats: [], 
            activeChatThread: null,
            initialLoadComplete: false,
            mapInstance: null
        };

        window.getLocation = function() {
            if (navigator.geolocation) {
                const btn = document.getElementById('btn-get-loc');
                if(btn) btn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> Finding you...';
                lucide.createIcons();
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        state.donationCoords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        state.donationLocation = "Current Location";
                        window.showToast("Location Found!", "success");
                        render(); // Re-render to update UI
                    },
                    (error) => {
                        console.error(error);
                        window.showToast("GPS Error: " + error.message, "error");
                        if(btn) btn.innerHTML = '<i data-lucide="map-pin"></i> Use My Current Location';
                        lucide.createIcons();
                    }
                );
            } else {
                window.showToast("Geolocation not supported", "error");
            }
        };

        window.startRealtimeListeners = function() {
            if (!window.isConfigured) return;
            const db = window.db; const appId = window.appId;
            
            // Sync Items
            window.onSnapshot(window.collection(db, 'artifacts', appId, 'public', 'data', 'items'), (snapshot) => {
                state.items = [];
                snapshot.forEach(doc => { state.items.push({ id: doc.id, ...doc.data() }); });
                state.items.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                if (state.initialLoadComplete) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added" && window.currentUser && change.doc.data().authorId !== window.currentUser.uid) {
                            window.showToast(`üîî New: ${change.doc.data().title} added!`);
                            if (navigator.vibrate) navigator.vibrate(200);
                        }
                    });
                } else { state.initialLoadComplete = true; }
                
                if(state.view === 'browse') renderBrowse(document.getElementById('main-content'));
                if(state.view === 'map') renderMap(document.getElementById('main-content'));
                if(state.view === 'activity') renderActivity(document.getElementById('main-content'));
                
                // Update modal if open
                const sheet = document.getElementById('modal-sheet');
                if (!sheet.classList.contains('translate-y-full')) {
                    const openId = document.getElementById('modal-content').getAttribute('data-id');
                    if(openId) {
                        const item = state.items.find(i => i.id === openId);
                        if(item) openDetail(openId);
                        else closeModal(); // Item was deleted
                    }
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                if(error.code === 'permission-denied') {
                    window.showToast("Database Permission Denied", "error");
                    setTimeout(() => window.showToast("Update Firestore Rules in Console", "error"), 2000);
                }
            });

            // Sync Chat
            const q = window.query(window.collection(db, 'artifacts', appId, 'public', 'data', 'messages'), window.orderBy('timestamp', 'desc'), window.limit(100));
            window.onSnapshot(q, (snapshot) => {
                state.chats = [];
                snapshot.forEach(doc => { state.chats.push({ id: doc.id, ...doc.data() }); });
                if(state.view === 'chat') renderChat(document.getElementById('main-content'));
            });
        };

        function init() { 
            const savedTheme = localStorage.getItem('shareplate_theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                toggleDarkMode(true);
            }
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 1000); 
            lucide.createIcons(); 
        }

        function t(key) { return I18N[state.lang][key] || key; }
        function toggleDarkMode(force) { 
            state.darkMode = force !== undefined ? force : !state.darkMode; 
            if (state.darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            localStorage.setItem('shareplate_theme', state.darkMode ? 'dark' : 'light');
            render(); 
        }
        
        function setView(view) { 
            state.view = view; 
            if (view !== 'chat') state.activeChatThread = null;
            render(); 
            if (navigator.vibrate) navigator.vibrate(10); 
        }
        
        window.toggleUserMode = () => {
            const url = new URL(window.location);
            if (url.searchParams.get('mode') === 'guest') url.searchParams.delete('mode');
            else url.searchParams.set('mode', 'guest');
            window.location.href = url.toString();
        };

        window.showToast = function(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const bg = type === 'success' ? 'bg-slate-800 dark:bg-slate-700' : 'bg-red-500';
            el.className = `${bg} text-white text-xs font-bold px-4 py-3 rounded-2xl shadow-lg flex items-center gap-2 animate-scale-in backdrop-blur-md bg-opacity-90 border border-white/10`;
            el.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-4 h-4"></i> ${msg}`;
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'scale(0.9)'; setTimeout(() => el.remove(), 300); }, 3000);
        }

        function formatTimeLeft(expiryMs) {
            const now = Date.now();
            const diff = expiryMs - now;
            if (diff <= 0) return "Expired";
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 0) return `${hours}h ${minutes}m left`;
            return `${minutes}m left`;
        }

        // Updated: Auto-inject message into chat
        async function handleRequestItem(itemId) {
            if (!window.currentUser) {
                 window.forceLogin();
                 return;
            }
            const messageEl = document.getElementById('request-message');
            const message = messageEl ? messageEl.value : '';
            
            try {
                // 1. Add request to item document
                const itemRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'items', itemId);
                await window.updateDoc(itemRef, { 
                    requests: window.arrayUnion({ 
                        userId: window.currentUser.uid, 
                        userName: `User ${window.currentUser.uid.slice(0,4)}`, 
                        message, 
                        timestamp: Date.now() 
                    }) 
                });

                // 2. Auto-post message to chat thread to start conversation
                if (message) {
                    await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'messages'), {
                        text: message,
                        senderId: window.currentUser.uid,
                        senderName: `User ${window.currentUser.uid.slice(0,4)}`,
                        timestamp: window.serverTimestamp(),
                        threadId: itemId // Link to this item's chat
                    });
                }

                window.showToast("Request Sent & Chat Started!");
                
                // Optional: Open chat immediately
                // startChat(itemId);
                
            } catch (e) { 
                console.error(e); 
                window.showToast("Error sending request", "error"); 
            }
        }

        async function handleAcceptRequest(itemId, requesterId) {
            if (!window.isConfigured) return;
            try {
                const itemRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'items', itemId);
                await window.updateDoc(itemRef, { status: 'claimed', claimedBy: requesterId });
                window.showToast("Item Assigned & Synced!");
                closeModal();
            } catch (e) { console.error(e); }
        }

        // New function to delete an item
        async function deleteItem(itemId) {
            if(!confirm("Are you sure you want to delete this item?")) return;
            
            try {
                const itemRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'items', itemId);
                await window.deleteDoc(itemRef);
                window.showToast("Item Deleted Successfully!");
                closeModal();
            } catch(e) {
                console.error(e);
                window.showToast("Delete Failed: " + e.message, "error");
            }
        }

        function render() {
            const main = document.getElementById('main-content');
            const nav = document.getElementById('nav-bar');

            if (state.view === 'login') {
                nav.classList.add('hidden');
            } else {
                nav.classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(btn => { 
                    btn.classList.remove('text-violet-600', 'dark:text-violet-400'); 
                    btn.classList.add('text-slate-400'); 
                });
                const activeBtn = document.getElementById(`nav-${state.view}`);
                if(activeBtn) { activeBtn.classList.add('text-violet-600', 'dark:text-violet-400'); activeBtn.classList.remove('text-slate-400'); }
            }

            switch(state.view) {
                case 'login': renderLogin(main); break;
                case 'browse': renderBrowse(main); break;
                case 'map': renderMap(main); break;
                case 'donate': renderDonate(main); break;
                case 'pick_location': renderLocationPicker(main); break;
                case 'activity': renderActivity(main); break; 
                case 'profile': renderProfile(main); break;
                case 'chat': renderChat(main); break; // ‚úÖ RE-ADDED CHAT VIEW
            }
            lucide.createIcons();
        }

        function renderLogin(container) {
            container.innerHTML = `<div class="flex flex-col h-full justify-center px-8 text-center animate-slide-up"><div class="w-28 h-28 bg-gradient-to-tr from-violet-600 to-indigo-600 rounded-[32px] mx-auto mb-8 flex items-center justify-center text-white shadow-2xl shadow-violet-500/30"><i data-lucide="chef-hat" class="w-14 h-14"></i></div><h1 class="text-4xl font-black text-slate-900 dark:text-white mb-2">SharePlate</h1><p class="text-slate-500 dark:text-slate-400 font-medium text-lg mb-10">${t('subtitle')}</p><button onclick="setView('browse'); window.forceLogin();" class="w-full py-5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-2xl shadow-xl hover:scale-[1.02] active:scale-95 transition-all">Start Exploring</button></div>`;
        }

        function renderBrowse(container) {
            // Filter out claimed items from the main browse feed
            const filteredItems = state.items.filter(i => 
                (state.activeCategory === 'All' || i.type === state.activeCategory) && 
                i.status !== 'claimed' // ‚úÖ HIDE CLAIMED ITEMS
            );
            let itemsHtml = filteredItems.map(item => {
                const isClaimed = item.status === 'claimed';
                const timeLeft = item.expiresAt ? formatTimeLeft(item.expiresAt) : 'Unknown';
                const priceDisplay = item.price && item.price > 0 ? `$${item.price}` : 'Free';
                const priceColor = item.price && item.price > 0 ? 'text-slate-900 dark:text-white' : 'text-emerald-600 dark:text-emerald-400';

                return `<div class="bg-white dark:bg-slate-800 rounded-[32px] p-4 shadow-sm border border-slate-100 dark:border-slate-700/50 mb-4 animate-scale-in relative group ${isClaimed ? 'opacity-50 grayscale' : ''}" onclick="openDetail('${item.id}')"><div class="flex gap-4"><div class="w-28 h-28 rounded-2xl bg-gradient-to-br ${item.bg || 'from-gray-400 to-slate-500'} flex items-center justify-center text-5xl shadow-inner shrink-0 relative overflow-hidden">${item.img}${isClaimed ? `<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-xs font-black text-white uppercase -rotate-12 tracking-widest border-2 border-white">CLAIMED</div>` : ''}</div><div class="flex-1 py-1 flex flex-col justify-between"><div><div class="flex justify-between items-start"><span class="text-[10px] font-extrabold tracking-wider uppercase text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded-lg">${item.type}</span><span class="text-[10px] font-bold ${timeLeft === 'Expired' ? 'text-red-500' : 'text-emerald-500'}">${timeLeft}</span></div><h3 class="font-bold text-lg text-slate-800 dark:text-white leading-tight mt-1 mb-1">${item.title}</h3><p class="text-xs font-medium text-slate-500 dark:text-slate-400">By ${item.author || 'Anon'}</p></div><div class="flex justify-between items-end"><div class="flex items-center gap-1 text-xs font-bold text-violet-600 dark:text-violet-400 bg-violet-50 dark:bg-violet-900/30 px-2 py-1 rounded-lg"><i data-lucide="map-pin" class="w-3 h-3"></i> ${item.locationName ? item.locationName.split(' ')[0] : 'Nearby'}</div><div class="font-bold ${priceColor}">${priceDisplay}</div></div></div></div></div>`;
            }).join('');
            
            container.innerHTML = `
                <div class="px-6 pb-20">
                    <div class="mb-8 flex justify-between items-center">
                        <div>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider flex items-center gap-1">${t('welcome')} <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span></p>
                            <h2 class="text-2xl font-black text-slate-900 dark:text-white">User ${window.currentUser?.uid.slice(0,4)}</h2>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-white dark:border-slate-600">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${window.currentUser?.uid}" alt="avatar">
                        </div>
                    </div>
                    ${itemsHtml || '<div class="text-center py-20 text-slate-400 flex flex-col items-center"><i data-lucide="cloud-off" class="w-12 h-12 mb-2 opacity-50"></i><p>No active items.</p><p class="text-xs mt-2">Add something on your PC to see it here!</p></div>'}
                </div>
            `;
        }

        function renderMap(container) {
            container.innerHTML = `<div id="map-container" class="w-full h-full relative z-0"></div>`;
            
            setTimeout(() => {
                if (state.mapInstance) {
                    state.mapInstance.remove();
                }
                
                // Centered on Sulaymaniyah, Iraq [35.557, 45.435]
                const map = L.map('map-container', { zoomControl: false }).setView([35.557, 45.435], 13);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);

                // Add pins for items
                state.items.forEach(item => {
                    if(item.status !== 'claimed') {
                        let lat, lng;
                        
                        // Use real coords if available, otherwise random around Sulaymaniyah
                        if(item.coords) {
                            lat = item.coords.lat;
                            lng = item.coords.lng;
                        } else {
                            // Sulaymaniyah base: 35.557, 45.435
                            lat = 35.557 + (parseInt(item.id.slice(-2), 16) % 20 - 10) * 0.005;
                            lng = 45.435 + (parseInt(item.id.slice(-4, -2), 16) % 20 - 10) * 0.005;
                        }
                        
                        const marker = L.marker([lat, lng]).addTo(map);
                        
                        const priceDisplay = item.price && item.price > 0 ? `$${item.price}` : 'Free';
                        const popupContent = `
                            <div class="text-center">
                                <div class="text-3xl mb-1">${item.img}</div>
                                <b>${item.title}</b><br>
                                <span class="text-xs text-slate-500">${priceDisplay}</span><br>
                                <button onclick="window.openDetail('${item.id}')" class="mt-2 bg-slate-900 text-white text-xs px-2 py-1 rounded">View</button>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    }
                });
                
                state.mapInstance = map;
            }, 100);
        }

        function renderDonate(container) {
            const loc = state.donationLocation;
            container.innerHTML = `<div class="p-6 h-full flex flex-col animate-slide-up"><h2 class="text-2xl font-black text-slate-900 dark:text-white mb-6">${t('donateTitle')}</h2><div class="flex-1 space-y-6">
            
            <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Location</label>
            <button id="btn-get-loc" onclick="window.getLocation()" class="w-full h-16 rounded-2xl border-2 ${loc ? 'border-violet-500 bg-violet-50 dark:bg-violet-900/10 text-violet-600' : 'border-dashed border-slate-300 dark:border-slate-700 text-slate-400'} flex items-center justify-center gap-2 font-bold transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
                ${loc ? `<i data-lucide="map-pin"></i> ${loc}` : `<i data-lucide="crosshair"></i> Use My Current Location`}
            </button>
            </div>
            
            <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">${t('itemName')}</label><input id="input-title" type="text" placeholder="e.g. Leftover Pizza" class="w-full bg-white dark:bg-slate-800 border-none shadow-sm rounded-2xl py-4 px-4 font-bold text-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-violet-500 transition-all"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Type</label><select id="input-type" class="w-full bg-white dark:bg-slate-800 border-none rounded-2xl py-4 px-4 font-bold dark:text-white outline-none"><option>Meals</option><option>Bakery</option><option>Grocery</option></select></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Price (0 = Free)</label><input id="input-price" type="number" value="0" class="w-full bg-white dark:bg-slate-800 border-none rounded-2xl py-4 px-4 font-bold dark:text-white outline-none"></div>
            </div>
            
            <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Hours Available</label><input id="input-time" type="number" value="24" class="w-full bg-white dark:bg-slate-800 border-none rounded-2xl py-4 px-4 font-bold dark:text-white outline-none"></div></div><button onclick="submitDonationLive()" class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-2xl shadow-xl mt-auto active:scale-95 transition-transform">Publish Donation</button></div></div>`;
        }

        async function submitDonationLive() {
             const title = document.getElementById('input-title').value;
             if (!window.currentUser) { window.forceLogin(); return; }
             // Ensure location is set (either manual or GPS)
             if (!title || (!state.donationLocation && !state.donationCoords)) { window.showToast("Missing info or location!", "error"); return; }
             
             const hours = parseInt(document.getElementById('input-time').value) || 24;
             const price = parseInt(document.getElementById('input-price').value) || 0;
             
             // Default to Sulaymaniyah center if GPS failed but user proceeded
             const finalCoords = state.donationCoords || { lat: 35.557, lng: 45.435 };
             const finalLocName = state.donationLocation || "Sulaymaniyah";
             
             try { 
                 await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'items'), { 
                     title, 
                     type: document.getElementById('input-type').value, 
                     price: price,
                     author: `User ${window.currentUser.uid.slice(0,4)}`, 
                     authorId: window.currentUser.uid, 
                     locationName: finalLocName, 
                     coords: finalCoords, // Save GPS coords
                     bg: 'from-orange-400 to-red-500', 
                     img: 'üç≤', 
                     timestamp: window.serverTimestamp(), 
                     expiresAt: Date.now() + (hours * 3600 * 1000), 
                     status: 'available', 
                     requests: [] 
                 }); 
                 window.showToast("Item Published to Cloud!"); 
                 setView('browse'); 
            } catch(e) { console.error(e); window.showToast("Publish Failed: " + e.code, "error"); }
        }

        function renderLocationPicker(container) {
            container.innerHTML = `<div class="relative w-full h-full bg-slate-100 dark:bg-slate-900"><div class="absolute top-0 left-0 right-0 p-6 z-20"><button onclick="setView('donate')" class="bg-white dark:bg-slate-800 p-3 rounded-full shadow-lg border dark:border-slate-700 dark:text-white"><i data-lucide="arrow-left"></i></button></div><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-violet-600 animate-bounce"><i data-lucide="map-pin" class="w-12 h-12"></i></div><div class="absolute bottom-6 left-6 right-6 z-20"><button onclick="state.donationLocation='Salim St. Market'; setView('donate'); window.showToast('Location Selected')" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl">Confirm Location</button></div></div>`;
        }

        function renderProfile(container) {
            const isGuest = new URLSearchParams(window.location.search).get('mode') === 'guest';
            const currentUrl = window.location.href;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(currentUrl)}`;
            
            container.innerHTML = `
                <div class="p-6 pb-24 text-center animate-slide-up">
                    <div class="w-28 h-28 rounded-full border-4 border-white dark:border-slate-800 shadow-2xl mx-auto mb-4 overflow-hidden">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${window.currentUser?.uid}" alt="avatar">
                    </div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white">User ${window.currentUser?.uid.slice(0,4)}</h2>
                    <span class="text-sm font-bold text-violet-500 bg-violet-50 dark:bg-violet-900/20 px-3 py-1 rounded-full mt-2 inline-block shadow-sm">Online ‚Ä¢ Sync Active</span>
                    
                    <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                         <h3 class="text-sm font-bold text-slate-500 uppercase mb-4">Sync with Mobile</h3>
                         <div class="flex flex-col items-center gap-4">
                             <div class="p-2 bg-white rounded-xl shadow-md border border-slate-100">
                                 <img src="${qrUrl}" alt="Scan to Open" class="w-32 h-32 rounded-lg">
                             </div>
                             <p class="text-xs text-slate-400 max-w-xs">Scan this code with your phone camera to open this exact instance on mobile.</p>
                         </div>
                    </div>

                    <div class="mt-6 space-y-3">
                        <div class="bg-white dark:bg-slate-800 rounded-3xl overflow-hidden border border-slate-100 dark:border-slate-700 shadow-sm">
                            <div class="p-4 flex items-center justify-between cursor-pointer hover:bg-violet-50 dark:hover:bg-slate-700/50" onclick="window.toggleUserMode()">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center text-violet-600 dark:text-violet-400"><i data-lucide="repeat"></i></div>
                                    <div class="text-left"><p class="font-bold dark:text-white">${isGuest ? 'Switch to Main Link' : 'Switch to Guest Link'}</p><p class="text-[10px] text-slate-400">Test PC vs Mobile</p></div>
                                </div>
                                <i data-lucide="chevron-right" class="text-slate-300"></i>
                            </div>
                            
                            <!-- Dark Mode Toggle Inside Profile -->
                            <div class="p-4 flex items-center justify-between border-t border-slate-100 dark:border-slate-700 cursor-pointer" onclick="toggleDarkMode()">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300"><i data-lucide="${state.darkMode ? 'sun' : 'moon'}"></i></div>
                                    <div class="text-left"><p class="font-bold dark:text-white">Dark Mode</p></div>
                                </div>
                                <div class="w-12 h-6 rounded-full bg-slate-200 dark:bg-violet-600 relative transition-colors">
                                    <div class="w-4 h-4 bg-white rounded-full shadow-sm absolute top-1 transition-all ${state.darkMode ? 'left-7' : 'left-1'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Replaces Global Chat with Activity Dashboard
        function renderActivity(container) {
            const currentUid = window.currentUser?.uid;
            const myItems = state.items.filter(i => i.authorId === currentUid);
            const myClaims = state.items.filter(i => i.claimedBy === currentUid);

            let myItemsHtml = myItems.length ? myItems.map(i => `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl mb-2 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${i.img}</span>
                        <div>
                            <div class="font-bold text-sm dark:text-white">${i.title}</div>
                            <div class="text-[10px] text-slate-400">${new Date(i.timestamp?.seconds * 1000).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openDetail('${i.id}')" class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-500"><i data-lucide="eye" class="w-4 h-4"></i></button>
                    </div>
                </div>`).join('') : '<div class="text-center text-slate-400 text-xs py-4">You haven\'t shared anything yet.</div>';

            let myClaimsHtml = myClaims.length ? myClaims.map(i => `
                <div class="bg-violet-50 dark:bg-violet-900/20 p-4 rounded-2xl mb-2 flex justify-between items-center border border-violet-100 dark:border-violet-800">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${i.img}</span>
                        <div>
                            <div class="font-bold text-sm dark:text-white">${i.title}</div>
                            <div class="text-[10px] text-violet-500 font-bold">Claimed</div>
                        </div>
                    </div>
                    <button onclick="openDetail('${i.id}')" class="bg-white dark:bg-slate-800 p-2 rounded-xl text-violet-500 shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                </div>`).join('') : '<div class="text-center text-slate-400 text-xs py-4">You haven\'t claimed anything yet.</div>';

            container.innerHTML = `
                <div class="p-6 h-full flex flex-col">
                    <h2 class="text-2xl font-black dark:text-white mb-6">My Activity</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-violet-600 text-white p-4 rounded-3xl shadow-lg shadow-violet-500/30">
                            <div class="text-3xl font-black">${myItems.length}</div>
                            <div class="text-xs font-medium opacity-80">Items Shared</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-3xl shadow-sm">
                            <div class="text-3xl font-black text-slate-900 dark:text-white">${myClaims.length}</div>
                            <div class="text-xs font-medium text-slate-400">Items Rescued</div>
                        </div>
                    </div>

                    <h3 class="text-sm font-bold text-slate-400 uppercase mb-3">My Shared Items</h3>
                    <div class="mb-6">${myItemsHtml}</div>

                    <h3 class="text-sm font-bold text-slate-400 uppercase mb-3">My Claims</h3>
                    <div>${myClaimsHtml}</div>
                </div>
            `;
        }

        window.startChat = (itemId) => {
            state.activeChatThread = itemId;
            closeModal();
            setView('chat');
        };

        function renderChat(container) {
            const currentUid = window.currentUser?.uid;
            // Filter messages: If activeChatThread is set, only show matching. Otherwise show global.
            const filterId = state.activeChatThread || 'global';
            
            const msgs = state.chats
                .filter(m => (m.threadId || 'global') === filterId)
                .sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0))
                .map(m => `<div class="flex ${m.senderId === currentUid ? 'justify-end' : 'justify-start'} mb-4 animate-slide-up"><div class="max-w-[80%] ${m.senderId === currentUid ? 'bg-violet-600 text-white rounded-tr-none' : 'bg-white dark:bg-slate-800 dark:text-white rounded-tl-none border border-slate-100 dark:border-slate-700'} p-3 rounded-2xl shadow-sm"> ${m.senderId !== currentUid ? `<div class="text-[9px] font-bold text-slate-400 mb-1">${m.senderName}</div>` : ''} <p class="text-sm font-medium">${m.text}</p></div></div>`)
                .join('');
            
            const chatTitle = state.activeChatThread ? `Item Chat` : t('chat');
            const subTitle = state.activeChatThread ? `Private thread for this item` : `Global Public Room`;

            container.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="px-6 py-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-black dark:text-white">${chatTitle}</h2>
                            <p class="text-xs text-slate-400">${subTitle}</p>
                        </div>
                        <button onclick="setView('browse')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-xl text-slate-500 dark:text-slate-400">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto px-6 flex flex-col-reverse pt-4">${msgs || '<div class="text-center text-slate-400 py-10">No messages yet.</div>'}</div>
                    <div class="p-4 glass dark:glass-dark border-t dark:border-slate-700">
                        <form onsubmit="event.preventDefault(); submitMessage()" class="flex gap-2">
                            <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 bg-slate-100 dark:bg-slate-700 border-none rounded-xl px-4 py-3 font-bold dark:text-white outline-none focus:ring-2 focus:ring-violet-500">
                            <button type="submit" class="w-12 h-12 bg-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg active:scale-95 transition-transform"><i data-lucide="send"></i></button>
                        </form>
                    </div>
                </div>`;
        }

        function openDetail(id) {
            const item = state.items.find(i => i.id === id);
            if (!item || !window.currentUser) return;
            // Expose globally for map button
            window.openDetail = openDetail; 
            
            const isOwner = item.authorId === window.currentUser.uid;
            const timeLeft = item.expiresAt ? formatTimeLeft(item.expiresAt) : 'Unknown';
            const priceDisplay = item.price && item.price > 0 ? `$${item.price}` : 'Free';
            
            let actionArea = '';
            if (isOwner) {
                if (item.requests?.length > 0) {
                    actionArea = `<h3 class="font-bold dark:text-white mb-3">Incoming Requests</h3>` + item.requests.map(req => `<div class="flex flex-col bg-slate-50 dark:bg-slate-700/50 p-4 rounded-2xl mb-3 border dark:border-slate-700"><div class="flex justify-between items-start mb-2"><span class="text-sm font-bold dark:text-white">üë§ ${req.userName}</span></div><div class="bg-white dark:bg-slate-800 p-3 rounded-xl text-xs dark:text-slate-300 italic mb-3">"${req.message || 'Interested in this item.'}"</div><button onclick="handleAcceptRequest('${item.id}', '${req.userId}')" class="w-full bg-violet-600 text-white text-sm font-bold py-3 rounded-xl hover:bg-violet-700 shadow-md flex justify-center items-center gap-2">Accept Request <i data-lucide="check" class="w-4 h-4"></i></button></div>`).join('');
                } else { actionArea = `<div class="text-center text-slate-400 text-sm p-10 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl flex flex-col items-center gap-2"><i data-lucide="inbox"></i>No requests yet.</div>`; }
                
                // Add Chat Button for Owner
                actionArea += `<button onclick="startChat('${item.id}')" class="w-full mt-2 border-2 border-violet-600 text-violet-600 dark:text-violet-400 font-bold py-3 rounded-xl hover:bg-violet-50 dark:hover:bg-slate-800 flex justify-center items-center gap-2">üí¨ Chat with Requesters</button>`;
                
                // Add Delete Button for Owner
                actionArea += `<button onclick="deleteItem('${item.id}')" class="w-full mt-2 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-4 rounded-2xl hover:bg-red-100 dark:hover:bg-red-900/40 flex justify-center items-center gap-2 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Donation</button>`;
            } else {
                const hasRequested = item.requests?.some(r => r.userId === window.currentUser.uid);
                
                let mainButton = '';
                if (item.status === 'claimed') mainButton = `<div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-2xl text-center text-slate-400 font-bold">Item Already Claimed</div>`;
                else if (hasRequested) mainButton = `<div class="bg-violet-50 dark:bg-violet-900/20 p-4 rounded-2xl text-center text-violet-600 font-bold border border-violet-100 flex items-center justify-center gap-2 animate-pulse"><i data-lucide="clock" class="w-5 h-5"></i> Request Pending...</div>`;
                else mainButton = `
                    <div class="bg-slate-50 dark:bg-slate-700/30 p-4 rounded-2xl mb-4 border border-slate-200 dark:border-slate-700">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Message to Owner</label>
                        <textarea id="request-message" rows="2" class="w-full bg-white dark:bg-slate-800 p-3 rounded-xl text-sm font-medium text-slate-700 dark:text-white placeholder-slate-400 outline-none border border-slate-100 dark:border-slate-600 focus:border-violet-500 transition-colors resize-none" placeholder="Is this still available?"></textarea>
                    </div>
                    <button onclick="handleRequestItem('${item.id}')" class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-2xl shadow-xl flex items-center justify-center gap-2 text-lg active:scale-95 transition-transform">
                        Send Request <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                `;

                // Add Chat Button for Requester
                actionArea = `
                    ${mainButton}
                    <button onclick="startChat('${item.id}')" class="w-full mt-4 bg-violet-100 dark:bg-slate-700 text-violet-700 dark:text-violet-300 font-bold py-3 rounded-xl flex justify-center items-center gap-2 hover:bg-violet-200">üí¨ Message Owner</button>
                `;
            }

            document.getElementById('modal-content').innerHTML = `
                <div class="w-full h-64 rounded-[32px] bg-gradient-to-br ${item.bg} flex items-center justify-center text-9xl shadow-lg mb-6 relative overflow-hidden">
                    <button onclick="closeModal()" class="absolute top-4 right-4 z-20 w-10 h-10 bg-black/20 hover:bg-black/30 backdrop-blur-md rounded-full flex items-center justify-center text-white transition-all active:scale-95">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="absolute inset-0 bg-black/10"></div>
                    <span class="relative z-10 animate-float">${item.img}</span>
                </div>
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-3xl font-black text-slate-900 dark:text-white">${item.title}</h2>
                    <div class="text-xl font-bold text-violet-600 dark:text-violet-400 bg-violet-50 dark:bg-violet-900/30 px-3 py-1 rounded-xl">${priceDisplay}</div>
                </div>
                <p class="text-lg font-medium text-slate-500 dark:text-slate-400 mb-6">By ${item.author} ‚Ä¢ <span class="${timeLeft === 'Expired' ? 'text-red-500' : 'text-emerald-500'} font-bold">${timeLeft}</span></p>
                ${actionArea}
            `;
            document.getElementById('modal-sheet').classList.remove('translate-y-full');
            document.getElementById('modal-backdrop').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').setAttribute('data-id', id);
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal-sheet').classList.add('translate-y-full'); document.getElementById('modal-backdrop').classList.add('opacity-0', 'pointer-events-none'); }
        init();
    </script>
</body>
</html>
